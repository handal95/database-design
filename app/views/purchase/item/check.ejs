<!DOCTYPE html>
<html lang="en">
<%- include('../../_component/head.ejs', {titleName: '상품 주문 확인'})%>
<body>
    <!--메인 화면-->
    <%- include('../../_component/goto_main.ejs')%>

    <!--주문을 하고 order, payment 데이터가 생기는 걸로-->
    <h1>상품 주문 확인</h1>
    <%
        const data = {
            theater_name: "theater1",
            store_name: "3관",
            item_name: "혼영세트(팝콘+콜라L)",
            item_price: 8000,
            order_quantity: 3,
            purchase_category: "item",
        }
        data.payment_price = data.item_price * data.order_quantity
    %>
    <p>영화관 이름 : <%= data.theater_name %></p>
    <p>상점 이름 : <%= data.store_name %></p>
    <p>상품 이름 : <%= data.item_name %></p>
    <p>상품 가격 : <%= data.item_price %></p>
    <p>주문 갯수 : <%= data.order_quantity %></p>
    <p>결제 가격 : <%= data.payment_price %></p>

    <table>
        <thead>
            <tr>
                <th>영화관 이름</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>

    <!--결제 방법 선택-->
    <div>
        <select id="payment_method"></select>
        <button id="btn_pay">결제</button>
    </div>

    <script>
    const payment_method_category = ["신용카드", "무통장입금", "카카오페이", "포인트"];
    const payment_method = $("#payment_method");
    const btn_pay = $("#btn_pay");

    for (const element of payment_method_category)
    {
        payment_method.append(`<option value=${element}>${element}</option>`);
    }

    btn_pay.on('click', paycheck);

    async function paycheck()
    {
        // 세션 로그인 정보로부터 customer_code를 읽음
        const customer_response_data = await requestPostAPI('/purchase/item/check/customer_code');
        const customer_code = customer_response_data.data.customer_code;
        // 세션 만료인 상태라면 로그인 창으로 redirect
        if (customer_code == null)
        {
            alert("결제하려면 로그인을 해야 합니다.");
            window.location.href = '/signin';
            return false;
        }

        // 결제방법 정보 읽음
        const payment_method_data = {
            payment_method: payment_method.val()
        };
        const check_response_data = await requestPostAPI('/purchase/item/check/check_payment', payment_method_data);
        const is_payment_availabie = check_response_data.data.result;
        // 결제가 불가능하다면 false 반환
        if (is_payment_availabie == false)
        {
            alert('결제 실패, 다른 옵션을 선택하세요.');
            return false;
        }

        const theater_name = <%= theater_name %>;
        const store_name = <%= store_name %>;
        //*****
        const item_name = <%= item_name %>;
        const item_price = <%= item_price %>;
        const order_quantity = <%= order_quantity %>;

        const payment_price = <%= payment_price %>;
        const payment_process_data = {
            customer_code,
            adult_no,
            child_no,
            payment_price,
            payment_method: payment_method.val(),
            reserve_status: "예약"
        };

        const payment_process_response_data = await requestPostAPI('/purchase/movie/check/process_payment', payment_process_data);
        const is_payment_success = payment_process_response_data.data.result;

        // 결제 성공 시 결제 완료 페이지로 이동
        if (is_payment_success)
        {
            alert('결제 완료');
            const payment_uid = payment_process_response_data.data.payment_uid;
            const ticket_uid = payment_process_response_data.data.ticket_uid;
            const session_uid = payment_process_response_data.data.session_uid;

            // 필요한 정보를 string으로 변환 후 다음 페이지 요청
            const href = '/purchase/movie/complete';
            const queryParams = {
                    payment_uid,
                    ticket_uid,
                    session_uid,
                };
            const queryString = Object.entries(queryParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
            
            // 결제 완료 페이지로 payment_uid, ticket_uid, session_uid 전달
            window.location.href = `${href}?${queryString}`;
        }
        // 결제 실패 시 false 반환
        else
        {
            alert('결제 실패, 다시 시도하세요');
            return false;
        }
    }
    </script>
</body>
</html>